#!/usr/bin/env python3
# sentinel_smart_lock.py â€” FULL Integrated GUI + RFID + Face + Motor GUI Access Control

import sys
import os
sys.path.insert(0, os.path.abspath("/home/project/Desktop/Att/lib"))

import time
import datetime
import json
import sqlite3
import traceback
import subprocess
from threading import Thread, Lock, Event

import pandas as pd
import numpy as np
import cv2
import dlib
import tkinter as tk
from PIL import Image, ImageTk

frame = None
camera_cap = None

try:
    import RPi.GPIO as GPIO
    from mfrc522 import SimpleMFRC522
except Exception:
    GPIO = None
    SimpleMFRC522 = None
    print("âš  Running without GPIO/RFID hardware support.")

# ---------------- CONFIG ----------------
LOG_FILE = "Logs.csv"
MASTER_TAG = "769839607204"
RELAY_GPIO = 11
MOTOR_GPIO = 17            # â˜… NEW â€” motor control GPIO
GUI_DETECT_TIMEOUT = 2     # GUI disappears after no detection

DETECT_ACTIVE = False      # â˜… NEW â€” motor GUI activation flag
LAST_IDENT_NAME = None     # â˜… NEW â€” the user who unlocked

# ---------------- GPIO Setup ----------------
def gpio_setup():
    if GPIO:
        GPIO.setwarnings(False)
        GPIO.setmode(GPIO.BOARD)
        GPIO.setup(RELAY_GPIO, GPIO.OUT)
        GPIO.output(RELAY_GPIO, GPIO.LOW)

        GPIO.setup(MOTOR_GPIO, GPIO.OUT)       # â˜… NEW
        GPIO.output(MOTOR_GPIO, GPIO.LOW)      # motor OFF initially
gpio_setup()

# ---------------- STATE ----------------
csv_mutex = Lock()
frame_mutex = Lock()

active_rfid = {"text": "None", "last_seen": 0}
active_face = {"text": "None", "last_seen": 0}

# ---------------- Logging ----------------
def log_sentence(line):
    with csv_mutex:
        with open(LOG_FILE, "a") as f:
            f.write(f"{datetime.datetime.now()}, {line}\n")
    print(line)

# ---------------- RFID ----------------
reader = None
if SimpleMFRC522:
    try:
        reader = SimpleMFRC522()
    except:
        reader = None

def handle_rfid_detection(tag_id):
    global DETECT_ACTIVE, LAST_IDENT_NAME

    tag_str = str(tag_id)
    now = time.time()

    # MASTER TAG
    if tag_str == MASTER_TAG:
        active_rfid["text"] = "MASTER"
        active_rfid["last_seen"] = now
        DETECT_ACTIVE = not DETECT_ACTIVE   # toggle GUI permission
        LAST_IDENT_NAME = "MASTER"
        return

    # DB lookup
    try:
        conn = sqlite3.connect("rfid_data.db")
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM rfid_users WHERE tag_id=?", (tag_str,))
        row = cursor.fetchone()
        conn.close()
    except:
        row = None

    if not row:
        active_rfid["text"] = f"Unknown({tag_str})"
        active_rfid["last_seen"] = now
        return

    # Known user detected
    name = row[0]
    active_rfid["text"] = f"{name}"
    active_rfid["last_seen"] = now

    # â˜… NEW â€” activate motor GUI
    DETECT_ACTIVE = True
    LAST_IDENT_NAME = name + "-RFID"

# ---------------- FACE RECOGNITION ----------------
detector = dlib.get_frontal_face_detector()
try:
    predictor = dlib.shape_predictor("data/data_dlib/shape_predictor_68_face_landmarks.dat")
    face_model = dlib.face_recognition_model_v1("data/data_dlib/dlib_face_recognition_resnet_model_v1.dat")
except:
    predictor = None
    face_model = None

known_features, known_names = [], []
def load_face_db():
    if os.path.exists("data/features_all.csv"):
        df = pd.read_csv("data/features_all.csv", header=None)
        for i in range(df.shape[0]):
            known_names.append(df.iloc[i, 0])
            known_features.append([float(df.iloc[i, j]) for j in range(1, 129)])
load_face_db()

def handle_face_detection(name):
    global DETECT_ACTIVE, LAST_IDENT_NAME

    now = time.time()
    active_face["text"] = name
    active_face["last_seen"] = now

    if name == "Unknown":
        return

    # â˜… NEW â€” Activate GUI
    DETECT_ACTIVE = True
    LAST_IDENT_NAME = name + "-Face"

def face_thread_loop(stop_event):
    global frame
    while not stop_event.is_set():
        if predictor is None or face_model is None:
            time.sleep(0.5)
            continue

        with frame_mutex:
            local = None if frame is None else frame.copy()
        if local is None:
            time.sleep(0.05)
            continue

        try:
            bgr = cv2.cvtColor(local, cv2.COLOR_RGB2BGR)
            faces = detector(bgr, 0)

            for f in faces:
                shape = predictor(bgr, f)
                descriptor = np.array(face_model.compute_face_descriptor(bgr, shape))

                # Compare
                distances = [np.linalg.norm(descriptor - np.array(x)) for x in known_features]
                if distances and min(distances) < 0.6:
                    name = known_names[int(np.argmin(distances))]
                else:
                    name = "Unknown"

                handle_face_detection(name)
                break

        except:
            traceback.print_exc()

        time.sleep(0.15)

# ---------------- CAMERA ----------------
def camera_thread(stop_event):
    global camera_cap, frame

    for i in range(5):
        cap = cv2.VideoCapture(i)
        if cap.isOpened():
            camera_cap = cap
            break

    if camera_cap is None:
        print("Camera unavailable")
        return

    while not stop_event.is_set():
        ret, img = camera_cap.read()
        if ret:
            rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
            with frame_mutex:
                frame = rgb
        time.sleep(0.03)

    if camera_cap:
        camera_cap.release()

# ---------------- RFID THREAD ----------------
def rfid_thread(stop_event):
    if reader is None:
        return

    while not stop_event.is_set():
        try:
            uid, _ = reader.read_no_block()
            if uid:
                handle_rfid_detection(uid)
        except:
            traceback.print_exc()
        time.sleep(0.25)

# ---------------- GUI ----------------
class SentinelGUI:
    def __init__(self, root, stop_event):
        self.root = root
        self.stop_event = stop_event

        root.attributes("-fullscreen", True)
        root.configure(bg="#051421")

        # HEADER
        self.header = tk.Label(root, text="ðŸ›¡ Sentinel Smart Lock",
                               fg="#7EE0FF", bg="#051421",
                               font=("Helvetica", 30, "bold"))
        self.header.pack(pady=10)

        # TIME
        self.time_label = tk.Label(root, text="", fg="white",
                                   bg="#051421", font=("Helvetica", 16))
        self.time_label.pack()

        # CAMERA
        self.cam_frame = tk.Frame(root, bg="#0B2238")
        self.cam_frame.pack(pady=10)
        self.cam_label = tk.Label(self.cam_frame)
        self.cam_label.pack()

        # STATUS
        self.status_frame = tk.Frame(root, bg="#051421")
        self.status_frame.pack(pady=10)

        self.rfid_label = tk.Label(self.status_frame, text="RFID : None",
                                   fg="#9BFFD9", bg="#051421",
                                   font=("Helvetica", 18))
        self.rfid_label.pack()

        self.face_label = tk.Label(self.status_frame, text="Face : None",
                                   fg="#9BFFD9", bg="#051421",
                                   font=("Helvetica", 18))
        self.face_label.pack()

        # ---------------- MOTOR CONTROL GUI ----------------
        # â˜… NEW â€” ALWAYS visible but INACTIVE when not detected

        self.motor_frame = tk.Frame(root, bg="#000000")
        self.motor_frame.pack(pady=20)

        self.motor_title = tk.Label(self.motor_frame, text="Machine Control",
                                    font=("Helvetica", 22, "bold"),
                                    bg="#000000", fg="#FFBA63")
        self.motor_title.grid(row=0, column=0, columnspan=2, pady=10)

        self.btn_on = tk.Button(self.motor_frame, text=" MACHINE ON ",
                                font=("Helvetica", 20, "bold"),
                                state="disabled", bg="#444444", fg="white",
                                command=self.machine_on)
        self.btn_on.grid(row=1, column=0, padx=20, pady=10)

        self.btn_off = tk.Button(self.motor_frame, text=" MACHINE OFF ",
                                 font=("Helvetica", 20, "bold"),
                                 state="disabled", bg="#444444", fg="white",
                                 command=self.machine_off)
        self.btn_off.grid(row=1, column=1, padx=20, pady=10)

        # Add User Button
        self.add_btn = tk.Button(root, text="âž• ADD USER",
                                 font=("Helvetica", 22, "bold"),
                                 bg="#16A88A", fg="white",
                                 command=self.on_add_user)
        self.add_btn.pack(pady=10)

        self.update_time()
        self.update_cam()
        self.update_status()

        root.protocol("WM_DELETE_WINDOW", self.on_close)

    # ---------------- MOTOR BUTTON ACTIONS ----------------
    def machine_on(self):
        if GPIO:
            GPIO.output(MOTOR_GPIO, GPIO.HIGH)
        log_sentence(f"Machine ON accessed by {LAST_IDENT_NAME}")

        # â˜… NEW â€” After using machine â†’ GUI becomes inactive again
        self.disable_motor_access()

    def machine_off(self):
        if GPIO:
            GPIO.output(MOTOR_GPIO, GPIO.LOW)
        log_sentence(f"Machine OFF accessed by {LAST_IDENT_NAME}")

        # â˜… NEW â€” Disable again
        self.disable_motor_access()

    # Disable motor buttons
    def disable_motor_access(self):
        global DETECT_ACTIVE
        DETECT_ACTIVE = False
        self.btn_on.config(state="disabled", bg="#444444")
        self.btn_off.config(state="disabled", bg="#444444")

    # ---------------- GUI UPDATE LOOPS ----------------
    def update_time(self):
        self.time_label.config(text=datetime.datetime.now().strftime("%Y-%m-%d %I:%M:%S %p"))
        self.root.after(1000, self.update_time)

    def update_cam(self):
        with frame_mutex:
            local = None if frame is None else frame.copy()
        if local is not None:
            img = Image.fromarray(local).resize((320, 240))
            imgtk = ImageTk.PhotoImage(img)
            self.cam_label.imgtk = imgtk
            self.cam_label.config(image=imgtk)

        self.root.after(30, self.update_cam)

    def update_status(self):
        now = time.time()

        # Reset labels if expired
        if now - active_rfid["last_seen"] > GUI_DETECT_TIMEOUT:
            active_rfid["text"] = "None"

        if now - active_face["last_seen"] > GUI_DETECT_TIMEOUT:
            active_face["text"] = "None"

        self.rfid_label.config(text=f"RFID : {active_rfid['text']}")
        self.face_label.config(text=f"Face : {active_face['text']}")

        # ---------------- MOTOR GUI ACTIVATION ----------------
        if DETECT_ACTIVE:
            self.btn_on.config(state="normal", bg="#1BCE89")
            self.btn_off.config(state="normal", bg="#E85454")
        else:
            self.btn_on.config(state="disabled", bg="#444444")
            self.btn_off.config(state="disabled", bg="#444444")

        self.root.after(300, self.update_status)

    # ---------------- OTHER ----------------
    def on_add_user(self):
        self.stop_event.set()
        if camera_cap:
            camera_cap.release()
        subprocess.Popen([sys.executable, "/home/project/Desktop/Att/add.py"])
        os._exit(0)

    def on_close(self):
        self.stop_event.set()
        if GPIO:
            GPIO.output(MOTOR_GPIO, GPIO.LOW)
        if camera_cap:
            camera_cap.release()
        self.root.destroy()
        os._exit(0)

# ---------------- START ----------------
def start_all():
    stop_event = Event()

    Thread(target=camera_thread, args=(stop_event,), daemon=True).start()
    Thread(target=face_thread_loop, args=(stop_event,), daemon=True).start()
    Thread(target=rfid_thread, args=(stop_event,), daemon=True).start()

    root = tk.Tk()
    SentinelGUI(root, stop_event)
    root.mainloop()

if __name__ == "__main__":
    start_all()
